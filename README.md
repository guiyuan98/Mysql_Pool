# MySQL 连接池逻辑流程图

## 1. 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Mysql_Pool 连接池                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          空闲连接队列 (free_connections)              │   │
│  │  ┌────┐  ┌────┐  ┌────┐  ┌────┐                      │   │
│  │  │ C1 │→│ C2 │→│ C3 │→│ C4 │  (FIFO队列)              │   │
│  │  └────┘  └────┘  └────┘  └────┘                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          同步机制                                      │   │
│  │  • mutex_ (互斥锁)                                     │   │
│  │  • cv_ (条件变量) - 用于唤醒等待线程                    │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          统计信息 (PoolStats)                         │   │
│  │  • total_connections: 总连接数                         │   │
│  │  • free_connections:  空闲连接数                       │   │
│  │  • used_connections:  使用中连接数                     │   │
│  │  • waiting_threads:   等待线程数                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          后台线程                                      │   │
│  │  • cleaner_thread: 每30秒清理空闲连接                  │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
         ▲                          │
         │                          │
    get_connection()        return_connection()
         │                          │
         └──────────┬───────────────┘
                    │
            ┌───────▼────────┐
            │   用户线程      │
            └────────────────┘
```

## 2. get_connection() 详细流程图

```
开始 get_connection()
    │
    ▼
┌─────────────────────────┐
│ 检查 shutdown_ 状态     │
└──────┬──────────────────┘
       │
       ├─ 已关闭 → 抛出异常
       │
       ▼
┌─────────────────────────┐
│ 获取锁 (unique_lock)    │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ free_connections.empty()│ ◄─────────┐
│         ?               │           │
└──────┬──────────────────┘           │
       │                               │
       ├─ NO (有空闲连接) ─────────────┼─┐
       │                               │ │
       │   快速路径 ⚡                │ │
       │   ┌─────────────────────┐   │ │
       │   │ 1. 从队列取出连接    │   │ │
       │   │ 2. free_connections--│   │ │
       │   │ 3. used_connections++│   │ │
       │   │ 4. 更新使用时间      │   │ │
       │   │ 5. 返回连接          │   │ │
       │   └─────────────────────┘   │ │
       │           │                  │ │
       │           └─► 返回连接 ⚡    │ │
       │                              │ │
       ▼                              │ │
┌─────────────────────────┐           │ │
│ total_connections <     │           │ │
│    max_connections ?    │           │ │
└──────┬──────────────────┘           │ │
       │                               │ │
       ├─ YES (可以创建新连接) ────────┼─┤
       │                               │ │
       │   ┌─────────────────────┐    │ │
       │   │ 1. 释放锁 ⚠️        │    │ │
       │   │ 2. 创建新连接        │    │ │
       │   │ 3. 重新获取锁        │    │ │
       │   │ 4. used_connections++│    │ │
       │   │ 5. 返回连接          │    │ │
       │   └─────────────────────┘    │ │
       │           │                   │ │
       │           └─► 返回连接        │ │
       │                               │ │
       ▼                               │ │
┌─────────────────────────┐            │ │
│ 连接池已满，需要等待     │            │ │
│ waiting_threads++       │            │ │
└──────┬──────────────────┘            │ │
       │                                │ │
       ▼                                │ │
┌─────────────────────────────────────┐ │ │
│ cv_.wait_until(lock, expire_time)   │ │ │
│ 等待条件：                           │ │ │
│ • !free_connections.empty()  OR      │ │ │
│ • shutdown_  OR                      │ │ │
│ • total_connections < max           │ │ │
└──────┬──────────────────────────────┘ │ │
       │                                 │ │
       ├─ 超时                           │ │
       │   └─► waiting_threads--        │ │
       │       └─► 抛出超时异常         │ │
       │                                 │ │
       ├─ 被唤醒（条件满足）─────────────┼─┤
       │                                 │ │
       ▼                                 │ │
┌─────────────────────────┐             │ │
│ 检查 shutdown_          │             │ │
│ 如果已关闭 → 抛出异常    │             │ │
└──────┬──────────────────┘             │ │
       │                                 │ │
       ▼                                 │ │
┌─────────────────────────┐             │ │
│ free_connections.empty()│             │ │
│         ?               │             │ │
└──────┬──────────────────┘             │ │
       │                                 │ │
       ├─ NO (有空闲连接) ───────────────┤─┘
       │   ┌─────────────────────┐      │
       │   │ 1. 从队列取出连接    │      │
       │   │ 2. 更新统计         │      │
       │   │ 3. waiting_threads--│      │
       │   │ 4. 返回连接         │      │
       │   └─────────────────────┘      │
       │           │                     │
       │           └─► 返回连接          │
       │                                 │
       ▼                                 │
┌─────────────────────────┐             │
│ total_connections <     │             │
│    max_connections ?    │             │
└──────┬──────────────────┘             │
       │                                 │
       ├─ YES ──────────────────────────┤
       │   ┌─────────────────────┐      │
       │   │ 1. 释放锁           │      │
       │   │ 2. 创建新连接        │      │
       │   │ 3. 重新获取锁        │      │
       │   │ 4. 更新统计         │      │
       │   │ 5. waiting_threads--│      │
       │   │ 6. 返回连接         │      │
       │   └─────────────────────┘      │
       │           │                     │
       │           └─► 返回连接          │
       │                                 │
       └─ NO (超时且无法获取)            │
           └─► waiting_threads--        │
               └─► 抛出超时异常         │
```

## 3. return_connection() 流程图

```
开始 return_connection(conn)
    │
    ▼
┌─────────────────────────┐
│ 检查 conn 是否为空       │
│ 如果为空 → 直接返回      │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ 获取锁 (lock_guard)     │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ 1. 更新连接归还时间      │
│ 2. 重置连接状态          │
│ 3. 放入空闲队列          │
│ 4. free_connections++   │
│ 5. used_connections--   │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ cv_.notify_one() ⚡     │
│ 唤醒一个等待的线程        │
│ （关键优化点！）          │
└──────┬──────────────────┘
       │
       ▼
    结束
```

## 4. 条件变量交互时序图

```
线程1 (获取连接)          线程2 (归还连接)          连接池
    │                        │                      │
    │ get_connection()       │                      │
    ├───────────────────────►│                      │
    │                        │                      │
    │  空闲队列为空          │                      │
    │                        │                      │
    │  waiting_threads++     │                      │
    │                        │                      │
    │  cv_.wait_until()      │                      │
    │  ──────────────────────┼─────────────────────►│ (等待中...)
    │  (阻塞等待)            │                      │
    │                        │                      │
    │                        │ return_connection() │
    │                        ├─────────────────────►│
    │                        │                      │
    │                        │  连接放入队列        │
    │                        │  free_connections++  │
    │                        │                      │
    │                        │ cv_.notify_one() ⚡  │
    │                        │ ────────────────────►│
    │                        │                      │
    │ ◄──────────────────────┼──────────────────────┤
    │ 被唤醒！               │                      │
    │                        │                      │
    │  从队列获取连接        │                      │
    │  waiting_threads--     │                      │
    │  返回连接 ⚡           │                      │
    │                        │                      │
```

## 5. 连接池状态转换图

```
┌──────────────┐
│  初始化状态   │
│ 创建min个连接 │
└──────┬───────┘
       │
       ▼
┌────────────────────────────────────────┐
│         正常运行状态                    │
│                                        │
│  ┌────────────┐      ┌─────────────┐  │
│  │ 空闲连接    │◄─────┤ 使用中连接   │  │
│  │ (队列中)    │归还   │ (用户使用)   │  │
│  └─────┬──────┘      └──────┬──────┘  │
│        │                     │         │
│        │ 获取                │ 获取    │
│        └─────────────────────┘         │
│                                        │
│  • 获取连接: 空闲→使用中                │
│  • 归还连接: 使用中→空闲                │
│  • 连接池满: 线程等待 (cv_.wait)       │
│  • 连接归还: 唤醒等待线程 (cv_.notify) │
└────────────────────────────────────────┘
       │
       │ (每30秒)
       ▼
┌─────────────────────────┐
│   清理线程运行           │
│                        │
│  • 检查空闲连接有效性    │
│  • 清理超时连接          │
│  • 补充到min_connections│
└─────────────────────────┘
       │
       ▼
┌─────────────────────────┐
│   关闭状态               │
│                        │
│  • shutdown_ = true    │
│  • cv_.notify_all()    │
│  • 清理所有连接         │
└─────────────────────────┘
```

## 6. 关键优化点说明

### ⚡ 快速路径 (Fast Path)
```
有空闲连接 → 直接返回 (无等待，<1ms)
```

### 🔄 条件变量机制 (Event-Driven)
```
旧版本: 轮询等待 (50-100ms延迟)
新版本: 条件变量唤醒 (即时响应，<1ms)
```

### 🔓 锁释放优化
```
创建连接时释放锁 → 避免长时间持有锁
```

### 📊 统计一致性
```
• create_connection(false): 创建后直接使用，不加入空闲队列
• create_connection(true): 创建后加入空闲队列
```

## 7. 性能对比

| 场景 | 优化前 | 优化后 |
|------|--------|--------|
| 有空闲连接 | 50ms+ (轮询) | <1ms (直接返回) |
| 连接池满 | 50-100ms (轮询) | <1ms (条件变量唤醒) |
| CPU使用 | 高 (轮询线程) | 低 (事件驱动) |
| 线程数 | 3个 | 2个 |

